<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Generate Bill</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--teal:#006666;--muted:#f4f6f6}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--muted);padding:20px}
    .wrap{max-width:1000px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h2{margin:0 0 8px}
    .top-row{display:flex;justify-content:space-between;align-items:center}
    .back{background:#eee;color:#111;padding:8px 12px;border-radius:6px;text-decoration:none}
    label{display:block;margin-top:12px;font-weight:600}
    input,textarea,select{padding:8px;width:100%;margin-top:6px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
    .inline-row{display:flex;gap:8px}
    .inline-row > *{flex:1}
    .products{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .product-checkbox{border:1px solid #ddd;padding:8px;border-radius:6px;background:#fff;cursor:pointer}
    .product-checkbox input{margin-right:6px}
    #itemsContainer{margin-top:10px}
    .item-row{display:flex;gap:8px;margin-top:8px;align-items:center}
    .item-row input{width:120px}
    button{margin-top:14px;padding:10px 16px;background:var(--teal);color:#fff;border:none;border-radius:6px;cursor:pointer}
    .muted{color:#666;font-size:13px}
    #searchResults{border:1px solid #eee;border-radius:6px;padding:6px;max-height:180px;overflow-y:auto;display:none;background:#fff}
    #searchResults div{padding:8px;border-bottom:1px solid #f2f2f2;cursor:pointer}
    #searchResults div:hover{background:#fbfbfb}
    #billPreview{margin-top:16px;border-radius:8px;padding:14px;border:1px solid #eee;background:#fafafa;display:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e6e6e6;padding:8px;text-align:left}
    th{background:#f2f7f6;color:var(--teal)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .secondary{background:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-row">
      <div><h2>Generate Bill</h2><div class="muted">Fetch existing customer or enter details manually</div></div>
      <div><a class="back" href="home.html">← Back</a></div>
    </div>

    <!-- Search -->
    <label>Search Customer by name</label>
    <input id="searchName" placeholder="Type name (even one letter)..." autocomplete="off" />
    <div id="searchResults"></div>

    <hr/>

    <!-- Customer fields -->
    <label>Customer Name *</label>
    <input id="name" placeholder="Customer name (or pick from search)" />

    <label>Phone *</label>
    <input id="phone" placeholder="Phone number" />

    <label>Additional Phone</label>
    <input id="alt_phone" placeholder="Optional" />

    <label>Address *</label>
    <textarea id="address" rows="2" placeholder="Address"></textarea>

    <label style="margin-top:14px">Products (select multiple)</label>
    <div id="productsList" class="products"></div>

    <div id="itemsContainer"></div>

    <div class="inline-row">
      <div>
        <label>Rent Start</label>
        <input type="date" id="rent_start" />
      </div>
      <div>
        <label>Rent End</label>
        <input type="date" id="rent_end" />
      </div>
    </div>

    <div class="actions">
      <button id="btnPreview">Generate Bill (Preview)</button>
      <button id="btnDownload">Download Bill</button>
      <button class="secondary" id="btnReset">Reset</button>
    </div>

    <div id="billPreview"></div>
  </div>

<script>
  // ---------- CONFIG ----------
  const PRODUCTS = ["xframe","alige","piller box","wheels","painting ladder","motor","supportings","machine"];
  const productsList = document.getElementById('productsList');
  const itemsContainer = document.getElementById('itemsContainer');
  const searchInput = document.getElementById('searchName');
  const searchResults = document.getElementById('searchResults');
  const previewBox = document.getElementById('billPreview');
  let savedPayload = null; // used by download button

  // populate product checkboxes
  PRODUCTS.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'product-checkbox';
    div.innerHTML = `<label style="margin:0;cursor:pointer"><input type="checkbox" id="chk_${p}" /> ${p}</label>`;
    productsList.appendChild(div);
    // click toggles checkbox and row
    div.addEventListener('click', (e)=>{
      if (e.target.tagName === 'INPUT') return; // checkbox handled
      const chk = document.getElementById(`chk_${p}`);
      chk.checked = !chk.checked;
      toggleProductRow(p, chk.checked);
    });
    // listen change on checkbox
    div.querySelector('input').addEventListener('change', (ev)=>{
      toggleProductRow(p, ev.target.checked);
    });
  });

  function toggleProductRow(prod, isChecked){
    if (isChecked) {
      if (document.getElementById(`row_${prod}`)) return;
      const row = document.createElement('div');
      row.className = 'item-row';
      row.id = `row_${prod}`;
      row.innerHTML = `
        <div style="flex:1"><strong>${prod}</strong></div>
        <input placeholder="Price" id="price_${prod}" type="number" min="0" step="0.01" />
        <input placeholder="Quantity" id="qty_${prod}" type="number" min="1" value="1" />
        <div><button type="button" onclick="removeProduct('${prod}')">Remove</button></div>
      `;
      itemsContainer.appendChild(row);
    } else {
      const r = document.getElementById(`row_${prod}`);
      if (r) r.remove();
      const chk = document.getElementById(`chk_${prod}`);
      if (chk) chk.checked = false;
    }
  }

  function removeProduct(prod){
    const chk = document.getElementById(`chk_${prod}`);
    if (chk) chk.checked = false;
    const r = document.getElementById(`row_${prod}`);
    if (r) r.remove();
  }

  // ---------- LIVE SEARCH ----------
  let searchTimer = null;
  searchInput.addEventListener('keyup', () => {
    clearTimeout(searchTimer);
    const q = searchInput.value.trim();
    if (!q) {
      searchResults.style.display = 'none';
      searchResults.innerHTML = '';
      return;
    }
    // small debounce
    searchTimer = setTimeout(async () => {
      try {
        const res = await fetch('/api/customers?q=' + encodeURIComponent(q));
        const data = await res.json();
        if (!data || !data.rows) {
          searchResults.style.display = 'none';
          return;
        }
        if (data.rows.length === 0) {
          searchResults.style.display = 'block';
          searchResults.innerHTML = '<div class="muted">No results</div>';
          return;
        }
        searchResults.style.display = 'block';
        searchResults.innerHTML = data.rows.map(r => `<div data-id="${r.id}">${escapeHtml(r.name)} — ${escapeHtml(r.phone)}</div>`).join('');
        // attach listeners
        searchResults.querySelectorAll('div[data-id]').forEach(el=>{
          el.addEventListener('click', ()=> selectCustomer(el.getAttribute('data-id')));
        });
      } catch (err) {
        console.error(err);
      }
    }, 200);
  });

  // escape helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  // ---------- SELECT CUSTOMER ----------
  async function selectCustomer(id){
    try {
      const res = await fetch('/api/customer-details?id=' + encodeURIComponent(id));
      const data = await res.json();
      if (!data.success) { alert('Could not load customer'); return; }
      const c = data.customer;
      document.getElementById('name').value = c.name || '';
      document.getElementById('phone').value = c.phone || '';
      document.getElementById('alt_phone').value = c.alt_phone || '';
      document.getElementById('address').value = c.address || '';
      searchResults.style.display = 'none';
      // load most recent order items automatically if present
      if (data.orderDetails && data.orderDetails.length) {
        const last = data.orderDetails[0];
        // reset product rows
        PRODUCTS.forEach(p => {
          const chk = document.getElementById(`chk_${p}`);
          if (chk) chk.checked = false;
          const row = document.getElementById(`row_${p}`);
          if (row) row.remove();
        });
        // set rent dates if present
        if (last.order) {
          if (last.order.rent_start) document.getElementById('rent_start').value = last.order.rent_start.split('T')[0];
          if (last.order.rent_end) document.getElementById('rent_end').value = last.order.rent_end.split('T')[0];
        }
        // fill items
        (last.items || []).forEach(it => {
          const prod = it.product;
          const chk = document.getElementById(`chk_${prod}`);
          if (chk) chk.checked = true;
          toggleProductRow(prod, true);
          const priceEl = document.getElementById(`price_${prod}`);
          const qtyEl = document.getElementById(`qty_${prod}`);
          if (priceEl) priceEl.value = Number(it.price);
          if (qtyEl) qtyEl.value = Number(it.quantity);
        });
      }
    } catch (err) {
      console.error(err);
      alert('Error loading customer');
    }
  }

  // ---------- PREVIEW ----------
  document.getElementById('btnPreview').addEventListener('click', generatePreview);

  function collectItemsFromUI(){
    const items = [];
    for (const p of PRODUCTS){
      const chk = document.getElementById(`chk_${p}`);
      if (chk && chk.checked){
        const price = parseFloat(document.getElementById(`price_${p}`).value || 0);
        const qty = parseInt(document.getElementById(`qty_${p}`).value || 0, 10);
        if (!isFinite(price) || price <= 0 || !Number.isInteger(qty) || qty <= 0) {
          throw new Error(`Enter valid price & qty for ${p}`);
        }
        items.push({ product: p, price, quantity: qty });
      }
    }
    if (items.length === 0) throw new Error('Select at least one product');
    return items;
  }

  function computeDays(start, end){
    if (!start || !end) return 1;
    const s = new Date(start);
    const e = new Date(end);
    if (isNaN(s) || isNaN(e)) return 1;
    const diff = Math.floor((e - s) / (1000*60*60*24)) + 1;
    return Math.max(1, diff);
  }

  function generatePreview(){
    try {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const alt = document.getElementById('alt_phone').value.trim();
      if (!name || !phone || !address) { alert('Fill customer name, phone and address'); return; }

      const rent_start = document.getElementById('rent_start').value || null;
      const rent_end = document.getElementById('rent_end').value || null;
      const days = computeDays(rent_start, rent_end);

      const items = collectItemsFromUI();

      // compute totals
      let grand = 0;
      const rows = items.map(it=>{
        const amt = Number(it.price) * Number(it.quantity) * days;
        grand += amt;
        return { ...it, amount: amt };
      });

      // store payload for download (server expects items with price & quantity)
      savedPayload = {
        name, phone, alt_phone: alt, address, rent_start, rent_end,
        items: items.map(it => ({ product: it.product, price: it.price, quantity: it.quantity }))
      };

      // render preview
      let html = `<div style="display:flex;justify-content:space-between;align-items:center">
                    <div><h3 style="margin:0">SUBRAMANI ENTERPRISES</h3>
                    <div class="muted">Phone: 9916067960, 8073024022</div></div>
                    <div style="text-align:right"><small>${new Date().toLocaleDateString()}</small></div>
                  </div>
                  <hr/>
                  <div><strong>Name:</strong> ${escapeHtml(name)} &nbsp; <strong>Phone:</strong> ${escapeHtml(phone)}</div>
                  <div><strong>Address:</strong> ${escapeHtml(address)}</div>
                  <div style="margin-top:8px"><strong>Rent:</strong> ${rent_start||'N/A'} ${rent_end?(' to ' + rent_end):''}</div>
                  <table>
                    <thead><tr><th>Description</th><th>Price</th><th>Qty</th><th>Amount</th></tr></thead><tbody>`;

      rows.forEach(r=> {
        html += `<tr><td>${escapeHtml(r.product)}</td><td>${Number(r.price).toFixed(2)}</td><td>${r.quantity}</td><td>₹ ${Number(r.amount).toFixed(2)}</td></tr>`;
      });

      html += `<tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td><strong>₹ ${Number(grand).toFixed(2)}</strong></td></tr>`;
      html += `</tbody></table>`;

      previewBox.innerHTML = html;
      previewBox.style.display = 'block';
      previewBox.scrollIntoView({behavior:'smooth'});
    } catch (err) {
      alert(err.message || 'Error building preview');
    }
  }

  // ---------- DOWNLOAD (call backend) ----------
  document.getElementById('btnDownload').addEventListener('click', async ()=>{
    if (!savedPayload) {
      // try to auto-generate payload from UI
      try {
        generatePreview(); // will set savedPayload
      } catch (e) {
        alert('Generate preview first or fix the input');
        return;
      }
    }
    // final check
    if (!savedPayload) { alert('No bill data to send'); return; }

    try {
      const res = await fetch('/api/generate-bill', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(savedPayload)
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.error || 'Error generating bill');
        return;
      }
      // open invoice PDF
      window.open(`/api/invoice/${data.orderId}`, '_blank');
    } catch (err) {
      console.error(err);
      alert('Server error while generating bill');
    }
  });

  // ---------- RESET ----------
  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('name').value='';
    document.getElementById('phone').value='';
    document.getElementById('alt_phone').value='';
    document.getElementById('address').value='';
    document.getElementById('rent_start').value='';
    document.getElementById('rent_end').value='';
    searchInput.value = '';
    searchResults.style.display = 'none';
    previewBox.style.display = 'none';
    savedPayload = null;
    // remove rows & uncheck products
    PRODUCTS.forEach(p=>{
      const chk = document.getElementById(`chk_${p}`);
      if (chk) chk.checked = false;
      const r = document.getElementById(`row_${p}`);
      if (r) r.remove();
    });
  });

  // ---------- helpful: press Enter in search to select first result ----------
  searchInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      const first = searchResults.querySelector('div[data-id]');
      if (first) selectCustomer(first.getAttribute('data-id'));
    }
  });

  // ---------- init ----------
  (function init(){ /* nothing to do for now */ })();

</script>
</body>
</html>
