<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>New Customer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial;background:#f7f7f7;padding:20px}
  .card{background:#fff;padding:18px;border-radius:10px;max-width:920px;margin:0 auto;
        box-shadow:0 8px 24px rgba(0,0,0,.06)}
  label{display:block;margin-top:10px;font-weight:600}
  input,textarea{padding:8px;width:100%;margin-top:6px;border:1px solid #ddd;border-radius:6px}
  .products{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .product-checkbox{border:1px solid #ddd;padding:8px;border-radius:6px}
  .item-row{display:flex;gap:8px;margin-top:8px;align-items:center}
  .item-row input{width:120px}
  button{margin-top:14px;padding:10px 16px;background:#000;color:#fff;border:none;border-radius:6px;cursor:pointer}
</style>
</head>

<body>
<div class="card">
  <h2>New Customer ‚Äî Create Order</h2>

  <a href="home.html" style="background:#ddd;padding:6px 10px;border-radius:6px;text-decoration:none;color:#111">‚Üê Back</a>

  <label>Date (auto)</label>
  <input id="order_date" readonly />

  <label>Customer Name *</label>
  <input id="name" />

  <label>Phone *</label>
  <input id="phone" />

  <label>Alt Phone</label>
  <input id="alt_phone" />

  <label>Address *</label>
  <textarea id="address" rows="2"></textarea>

  <label>Products</label>
  <div id="productsList" class="products"></div>

  <div id="itemsContainer"></div>

  <label>Rent Start</label>
  <input type="date" id="rent_start" />

  <label>Rent End</label>
  <input type="date" id="rent_end" />

  <button onclick="submitForm()">Submit</button>
  <button onclick="resetForm()" style="background:#666">Reset</button>
</div>

<script>
const PRODUCTS = ["xframe","alige","piller box","wheels","painting ladder","motor","supportings","machine"];

document.getElementById("order_date").value = new Date().toISOString().slice(0,10);

PRODUCTS.forEach(p=>{
  document.getElementById("productsList").innerHTML += `
    <div class="product-checkbox">
      <input type="checkbox" onchange="toggleItem('${p}')" id="chk_${p}"> ${p}
    </div>`;
});

function toggleItem(p){
  const chk=document.getElementById(`chk_${p}`).checked;
  if(chk){
    document.getElementById("itemsContainer").innerHTML += `
      <div class="item-row" id="row_${p}">
        <strong style="flex:1">${p}</strong>
        <input id="price_${p}" placeholder="Price" type="number">
        <input id="qty_${p}" placeholder="Qty" type="number" value="1">
        <button onclick="removeRow('${p}')">Remove</button>
      </div>`;
  } else removeRow(p);
}

function removeRow(p){
  const r=document.getElementById(`row_${p}`);
  if(r) r.remove();
  document.getElementById(`chk_${p}`).checked=false;
}

function resetForm(){
  location.reload();
}

async function submitForm() {
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const alt_phone = document.getElementById('alt_phone').value.trim();
  const rent_start = document.getElementById('rent_start').value || null;
  const rent_end = document.getElementById('rent_end').value || null;

  if (!name || !phone || !address) {
    alert("Please fill name, phone and address");
    return;
  }

  const items = [];
  for (const p of PRODUCTS) {
    if (document.getElementById(`chk_${p}`).checked) {
      const price = parseFloat(document.getElementById(`price_${p}`).value || "0");
      const qty = parseInt(document.getElementById(`qty_${p}`).value || "0", 10);
      if (!isFinite(price) || price <= 0 || qty <= 0) {
        alert(`Enter valid price & qty for ${p}`);
        return;
      }
      items.push({ product: p, price, quantity: qty });
    }
  }

  if (items.length === 0) { alert("Select at least one product"); return; }

  const payload = {
    name, phone, alt_phone, address, rent_start, rent_end,
    items,
    order_date: new Date().toISOString().slice(0, 10)
  };

  try {
    const res = await fetch('/api/new-customer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("SERVER RESPONSE:", data); // DEBUG

    if (!res.ok || !data.success) {
      alert(data.error || "Server error");
      return;
    }

    // üî•üî•üî• FIXED: Redirect with customerId
    const cid = data.customerId;

    if (!cid) {
      alert("Error: customerId not received from server");
      return;
    }

    window.location.href = `customer_details.html?customerId=${cid}`;

  } catch (err) {
    console.error("Request error:", err);
    alert("Server error");
  }
}

</script>

</body>
</html>
